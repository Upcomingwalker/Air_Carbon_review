<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Air Carbon Project Review</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

<div class="container">
  <h1>Review Air Carbon</h1>
  
  <label for="name">Your Name</label>
  <input type="text" id="name" placeholder="Enter your name" required>
  
  <label for="review">Review of the Project</label>
  <textarea id="review" rows="4" placeholder="Write your review here..." required></textarea>
  
  <label for="role">Select Your Role</label>
  <select id="role" onchange="showRoleSpecificFields()">
    <option value="">Select Role</option>
    <option value="judge">Judge</option>
    <option value="student">School Student</option>
    <option value="teacher">School Teacher</option>
  </select>
  
  <div id="role-specific-fields" class="role-specific-fields"></div>
  
  <button type="submit" onclick="submitForm()">Submit</button>
  <button onclick="downloadResponses()">Download Spreadsheet</button>
  
  <p class="small-text">Thank You for submitting your review</p>
  <p class="small-text">copyright @ DTM Studios (2022-2024)</p>
</div>

<script>
  function showRoleSpecificFields() {
    const role = document.getElementById('role').value;
    const roleFields = document.getElementById('role-specific-fields');
    roleFields.innerHTML = '';

    if (role === 'judge') {
      roleFields.innerHTML = `
        <label>Do you want this project to win?</label>
        <div class="radio-buttons">
          <label>
            <input type="radio" name="judge-win" value="yes">
            Yes
          </label>
          <label>
            <input type="radio" name="judge-win" value="no">
            No
          </label>
        </div>
      `;
    } else if (role === 'student') {
      roleFields.innerHTML = `
        <label for="project-name">Your Project Name</label>
        <input type="text" id="project-name" placeholder="Enter your project name">
        
        <label for="school-name">Your School Name</label>
        <input type="text" id="school-name" placeholder="Enter your school name">
      `;
    } else if (role === 'teacher') {
      roleFields.innerHTML = `
        <label>Do you want this project to win?</label>
        <div class="radio-buttons">
          <label>
            <input type="radio" name="teacher-win" value="yes">
            Yes
          </label>
          <label>
            <input type="radio" name="teacher-win" value="no">
            No
          </label>
        </div>
        
        <label for="teacher-school-name">Your School Name</label>
        <input type="text" id="teacher-school-name" placeholder="Enter your school name">
        
        <label for="designation">Your Designation</label>
        <input type="text" id="designation" placeholder="Enter your designation">
      `;
    }
  }

  async function submitForm() {
    const name = document.getElementById('name').value.trim();
    const review = document.getElementById('review').value.trim();
    const role = document.getElementById('role').value;

    if (!name || !review || !role) {
      alert('Please fill all required fields!');
      return;
    }

    let additionalData = {};
    if (role === 'judge') {
      const judgeWin = document.querySelector('input[name="judge-win"]:checked');
      additionalData.wantsToWin = judgeWin ? judgeWin.value : '';
    } else if (role === 'student') {
      additionalData.projectName = document.getElementById('project-name').value.trim();
      additionalData.schoolName = document.getElementById('school-name').value.trim();
    } else if (role === 'teacher') {
      const teacherWin = document.querySelector('input[name="teacher-win"]:checked');
      additionalData.wantsToWin = teacherWin ? teacherWin.value : '';
      additionalData.schoolName = document.getElementById('teacher-school-name').value.trim();
      additionalData.designation = document.getElementById('designation').value.trim();
    }

    const response = {
      name,
      review,
      role,
      ...additionalData,
    };

    try {
      await fetch('http://localhost:5000/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(response),
      });

      alert('Form submitted successfully!');
      clearForm();
    } catch (error) {
      alert('Failed to submit form. Please try again.');
    }
  }

  async function downloadResponses() {
    try {
      const response = await fetch('http://localhost:5000/download');
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Air_Carbon_Project_Responses.xlsx';
      document.body.appendChild(a);
      a.click();
      a.remove();
    } catch (error) {
      alert('Failed to download responses. Please try again.');
    }
  }

  function clearForm() {
    document.getElementById('name').value = '';
    document.getElementById('review').value = '';
    document.getElementById('role').value = '';
    document.getElementById('role-specific-fields').innerHTML = '';
  }
</script>

</body>
</html>
